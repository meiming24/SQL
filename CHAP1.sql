USE CHAP1;


--CREATE TABLE LOP(MALOP CHAR(10) PRIMARY KEY, TENLOP NVARCHAR(100), SOSV INT)

--CREATE TABLE SV(MASV CHAR(10) PRIMARY KEY, TENSV NVARCHAR(100), GIOITINH NCHAR(3), NGAYSINH DATE, MALOP CHAR(10) REFERENCES LOP(MALOP) NOT NULL, TINH NVARCHAR(100), HOCBONG FLOAT)

--CREATE TABLE MONHOC(MAMH CHAR(10) PRIMARY KEY, TENMH NVARCHAR(50), SOTC INT)

--CREATE TABLE DIEM(MASV CHAR(10) NOT NULL REFERENCES SV(MASV) , MAMH CHAR(10) NOT NULL REFERENCES MONHOC(MAMH) , DIEM1 FLOAT, DIEM2 FLOAT, DIEM3 FLOAT, DIEMHP FLOAT, PRIMARY KEY(MASV, MAMH))


EXEC SP_HELPDB CHAP1
EXEC SP_HELP SV
EXEC SP_HELP LOP
EXEC SP_HELP MONHOC
EXEC SP_HELP DIEM
EXEC sp_helptext V_DIEM3
SELECT * FROM V_DIEM3 WHERE GIOITINH = N'Nữ'

CREATE PROC sp_Malop @Malop char(10)
AS
SELECT * FROM SV WHERE MALOP = @Malop 
EXEC sp_Malop 'CNTT62A'
--Viết thủ tục tìm gender và class id
CREATE PROC sp_Malop1 @Malop char(10), @gt nchar(6)
AS
SELECT * FROM SV WHERE MALOP = @Malop and GIOITINH = @gt

DROP PROC sp_Malop

INSERT INTO LOP VALUES ('HTQL64A', N'HTTT QUẢN LÝ 64A', 0);
DELETE FROM LOP WHERE MALOP = 'HTQL64A'

--Thủ tục xóa lớp
ALTER PROC sp_XoaLop @Malop char(10)
AS
BEGIN
IF(EXISTS (SELECT MALOP FROM SV WHERE MALOP = @Malop))
Print N'Mã sinh viên đang tồn tại trong bảng';
ELSE DELETE FROM LOP WHERE MALOP = @Malop
END;
--Thêm lớp
CREATE PROC sp_ThemLop @Malop char(10), @Tenlop nvarchar(200), @Sosv int
AS
BEGIN
IF(EXISTS (SELECT MALOP FROM LOP WHERE MALOP = @Malop))
Print N'Mã lớp này đang tồn tại trong bảng';
ELSE INSERT INTO LOP VALUES (@Malop, @Tenlop, @Sosv) 
END;

EXEC sp_ThemLop 'MAR62A',N'Marketing 62A',0
EXEC sp_XoaLop 'CNTT62A'
SELECT * FROM LOP
EXEC sp_Malop1 'CNTT62A', N'Nữ'

--Thêm, Xóa Sinh viên
--Thêm SV
CREATE PROC sp_ThemSV @Masv char(10), @Tensv nvarchar(100), @Gioitinh nvarchar(3), @Ngaysinh date, @Malop char(10), @Tinh nvarchar(100), @Hobo float
AS
BEGIN
IF(EXISTS (SELECT MASV FROM SV WHERE MASV = @Masv ))
PRINT N'Đã tồn tại sinh viên'
IF NOT EXISTS (select MALOP FROM LOP WHERE @Malop = MALOP)
PRINT N'Sinh viên không tồn tại'
ELSE INSERT INTO SV VALUES (@Masv, @Tensv, @Gioitinh, @Ngaysinh, @Tinh, @Hobo)
END;
--Xóa SV
ALTER PROC sp_XoaSV @Masv char(10)
BEGIN
IF(EXISTS (SELECT MASV FROM DIEM WHERE MASV = @Masv ))
PRINT N'Đã tồn tại sinh viên'
IF NOT EXISTS (select MASV FROM sv WHERE @Malop = MALOP))
PRINT N'Sinh viên không tồn tại'
ELSE delete from SV where @Masv = MASV
END;
--Thêm môn học
CREATE PROC  sp_ThemMH @mamh char(10), @tenmh nvarchar(100), @sotc float
as
begin
if(exists(select MAMH from MONHOC WHERE MAMH = @mamh))
Print 'Tồn tại môn học'
else Insert into MONHOC values (@mamh, @tenmh, @sotc)
end;
--Xóa môn học
ALTER PROC  sp_XoaMH @mamh char(10), @tenmh nvarchar(100), @sotc float
as
begin
if(exists(select MAMH from MONHOC WHERE MAMH = @mamh))
Print 'Tồn tại môn học'
else delete from MONHOC where MAMH = @mamh and TENMH = @tenmh and SOTC = @sotc
end;

ALTER TABLE MONHOC ADD GHICHU NCHAR(100) -- THÊM TRƯỜNG GHICHU
ALTER TABLE MONHOC DROP COLUMN GHICHU  -- XÓA TRUONGF GHICHU
ALTER TABLE MONHOC ALTER COLUMN SOTC NCHAR(10) -- THAY ĐỔI KIỂU DŨ LIỆU TRƯỜNG SOTC THÀNH CHAR
EXEC SP_RENAME 'MONHOC.SOTC', 'TONGTC', 'COLUMN'; -- THAY ĐỔI TÊN TRƯỜNG SOTC THÀNH TONGTC


INSERT INTO LOP VALUES ('CNTT62A', N'CÔNG NGHỆ THÔNG TIN 62A', 0);
INSERT INTO LOP VALUES ('CNTT62B', N'CÔNG NGHỆ THÔNG TIN 62B', 0);
INSERT INTO LOP VALUES ('KHMT62', N'KHOA HỌC MÁY TÍNH 62', 0);
INSERT INTO LOP VALUES ('HTQL62A', N'HTTT QUẢN LÝ 62A', 0);
INSERT INTO LOP VALUES ('HTQL62B', N'HTTT QUẢN LÝ 62B', 0);

INSERT INTO SV VALUES ('SV1', N'TRẦN VĂN AN', N'NAM', '2002-5-12', 'CNTT62A', N'HÀ NỘI', 0)
INSERT INTO SV VALUES ('SV2', N'TRẦN THÁI HÀ', N'NAM', '2002-1-12', 'CNTT62A', N'HÀ NỘI', 0)
INSERT INTO SV VALUES ('SV3', N'TRẦN THANH TÂM', N'NỮ', '2002-12-15', 'CNTT62B', N'THANH HÓA', 0)
INSERT INTO SV VALUES ('SV4', N'TRINH QUỐC NAM', N'NAM', '2002-12-15', 'CNTT62B', N'THANH HÓA', 0)
INSERT INTO SV VALUES ('SV5', N'NGUYỄN THANH HÀ', N'NỮ', '2002-6-21', 'CNTT62A', N'THANH HÓA', 0)
INSERT INTO SV VALUES ('SV6', N'NGUYỄN THANH MINH', N'NAM', '2002-7-1', 'CNTT62A', N'THÁI BÌNH', 0)
INSERT INTO SV VALUES ('SV7', N'NGUYỄN HOÀI THANH', N'NỮ', '2002-6-1', 'CNTT62B', N'NINH THUẬN', 0)
INSERT INTO SV VALUES ('SV8', N'NGUYỄN DANH ANH', N'NAM', '2002-6-3', 'CNTT62A', N'NINH BÌNH', 0)
INSERT INTO SV VALUES ('SV9', N'NGUYỄN BINH TƯ', N'NAM', '2002-7-3', 'CNTT62B', N'BẾN TRE', 0)

INSERT INTO MONHOC VALUES ('TCC', N'TOÁN CAO CẤP', 3)
INSERT INTO MONHOC VALUES ('GDTC1', N'GIÁO DỤC THỂ CHẤT 1', 3)
INSERT INTO MONHOC VALUES ('TRR', N'TOÁN RỜI RẠC', 3)
INSERT INTO MONHOC VALUES ('VLDC1', N'VẬT LÝ ĐẠI CƯƠNG 1', 3)
INSERT INTO MONHOC VALUES ('GDTC2', N'GIÁO DỤC THỂ CHẤT 2', 3)

INSERT INTO DIEM VALUES ('SV2', 'TCC', 10,7,6.5,0)
INSERT INTO DIEM VALUES ('SV2', 'GDTC1', 10,7,6.5,0)
INSERT INTO DIEM VALUES ('SV2', 'GDTC2', 10,7,6.5,0)
INSERT INTO DIEM VALUES ('SV2', 'VLDC1', 10,7,6.5,0)
INSERT INTO DIEM VALUES ('SV2', 'TRR', 10,7,6.5,0)

INSERT INTO DIEM VALUES ('SV3', 'TCC', 10,7,6.5,0)
INSERT INTO DIEM VALUES ('SV3', 'GDTC1', 10,7,6.5,0)
INSERT INTO DIEM VALUES ('SV3', 'GDTC2', 10,7,6.5,0)
INSERT INTO DIEM VALUES ('SV3', 'VLDC1', 10,7,6.5,0)
INSERT INTO DIEM VALUES ('SV3', 'TRR', 10,7,6.5,0)

INSERT INTO DIEM VALUES ('SV4', 'TCC', 9,7,6.5,0)
INSERT INTO DIEM VALUES ('SV4', 'GDTC1', 10,7,7.5,0)
INSERT INTO DIEM VALUES ('SV4', 'GDTC2', 10,9,6.5,0)
INSERT INTO DIEM VALUES ('SV4', 'VLDC1', 9,7,8.5,0)
INSERT INTO DIEM VALUES ('SV4', 'TRR', 10,7,6.5,0)

INSERT INTO DIEM VALUES ('SV5', 'TCC', 9,8,5.5,0)
INSERT INTO DIEM VALUES ('SV5', 'GDTC1', 10,5,7.6,0)
INSERT INTO DIEM VALUES ('SV5', 'GDTC2', 10,3,6.9,0)

INSERT INTO DIEM VALUES ('SV6', 'TCC', 9,7,6.5,0)
INSERT INTO DIEM VALUES ('SV6', 'GDTC1', 10,7,7.5,0)
INSERT INTO DIEM VALUES ('SV6', 'GDTC2', 10,9,6.5,0)
INSERT INTO DIEM VALUES ('SV6', 'VLDC1', 9,7,8.5,0)
INSERT INTO DIEM VALUES ('SV6', 'TRR', 10,7,6.5,0)

INSERT INTO DIEM VALUES ('SV7', 'TCC', 9,7,6.5,0)
INSERT INTO DIEM VALUES ('SV7', 'GDTC1', 10,7,7.5,0)
INSERT INTO DIEM VALUES ('SV7', 'VLDC1', 9,7,8.5,0)
INSERT INTO DIEM VALUES ('SV7', 'TRR', 10,7,6.5,0)

INSERT INTO DIEM VALUES ('SV8', 'TCC', 9,7,6.5,0)
INSERT INTO DIEM VALUES ('SV8', 'GDTC1', 10,7,7.5,0)
INSERT INTO DIEM VALUES ('SV8', 'GDTC2', 10,9,6.5,0)
INSERT INTO DIEM VALUES ('SV8', 'VLDC1', 9,7,8.5,0)
INSERT INTO DIEM VALUES ('SV8', 'TRR', 10,7,6.5,0)

INSERT INTO DIEM VALUES ('SV9', 'TCC', 9,7,6.5,0)
INSERT INTO DIEM VALUES ('SV9', 'GDTC1', 10,7,7.5,0)
INSERT INTO DIEM VALUES ('SV9', 'GDTC2', 10,9,6.5,0)
INSERT INTO DIEM VALUES ('SV9', 'VLDC1', 9,7,8.5,0)
INSERT INTO DIEM VALUES ('SV9', 'TRR', 10,7,6.5,0)


SELECT COUNT(MALOP) AS SOLOP FROM LOP -- IN RA SỐ LỚP VỚI TRƯỜNG SỐ LỚP
SELECT COUNT(MALOP) FROM LOP -- IN RA SỐ LỚP (KHÔNG CÓ TRƯỜNG)
SELECT * FROM LOP
SELECT * FROM SV
SELECT * FROM MONHOC
SELECT * FROM DIEM

INSERT INTO DIEM (MASV, MAMH, DIEM1, DIEM2, DIEM3) VALUES('SV3', 'TCC', 10, 7, 6.5)

--XÓA ĐIỂM CỦA SV À MASV = 'SV3' VÀ MAMH = 'TCC'
DELETE FROM DIEM WHERE MASV='SV3' AND MAMH='TCC'
--UPDATE DIEMHP = DIEM1*0.1 + DIEM2*0.4 + DIEM3*0.5
UPDATE DIEM SET DIEMHP = DIEM1*0.1 + DIEM2*0.4 + DIEM3*0.5
UPDATE DIEM SET DIEMHP = DIEM1*0.1 + DIEM2*0.4 + DIEM3*0.5 WHERE MASV = 'SV3'
SELECT * FROM DIEM
--ĐẾM SỐ SV HỌC MÔN GDTC1
SELECT COUNT(MASV) AS SOSV FROM DIEM WHERE MAMH = 'GDTC1'
-- ĐẾM SỐ SV CÓ DIEMHP>=7
SELECT COUNT(MASV) AS SOSV FROM DIEM WHERE DIEMHP>=7

--THUC HANH NGAY 05-01-2022
SELECT DISTINCT GIOITINH FROM SV;
SELECT DISTINCT MASV FROM SV;
SELECT * FROM SV;
SELECT * FROM SV WHERE GIOITINH LIKE N'NAM'
SELECT * FROM SV WHERE GIOITINH LIKE N'NU'

--CHO RA SO LUONG SINH VIEN NAM, NU
SELECT GIOITINH, COUNT(MASV) AS SOLUONG FROM SV 
GROUP BY GIOITINH		

--CHO BIẾT SỐ LƯỢNG SINH VIÊN > 5
SELECT GIOITINH, COUNT(MASV) AS SOLUONG FROM SV 
GROUP BY GIOITINH	
HAVING COUNT(MASV) > 5

--TRONG TABLE, CHO BIẾT SỐ LƯỢNG SINH VIÊN TỪNG MÔN HỌC
SELECT MAMH, COUNT(MASV) AS SOLUONG FROM DIEM 
GROUP BY MAMH

SELECT MAMH, COUNT(MASV) AS SOLUONG FROM DIEM WHERE DIEMHP >= 8
GROUP BY MAMH

--LÀM VIỆC VỚI NHIỀU BẢNG, KẾT NỐI TỰ NHIÊN
CREATE VIEW SV_LOP
AS(
SELECT SV.MASV,TENSV, SV.MALOP, TENLOP, GIOITINH, NGAYSINH
FROM SV,LOP
WHERE LOP.MALOP = SV.MALOP)

CREATE VIEW V_DIEM1 
AS(
SELECT SV.MASV, TENSV, MALOP, DIEM.MAMH, TENMH, TONGTC, DIEM1, DIEM2, DIEM3, DIEMHP
FROM SV, MONHOC, DIEM
WHERE DIEM.MASV = SV.MASV AND DIEM.MAMH = MONHOC.MAMH)

--TẠO VIEW
CREATE VIEW V_DIEM2 
AS(
SELECT SV.MASV, TENSV, MALOP, DIEM.MAMH, TENMH, TONGTC, DIEM1, DIEM2, DIEM3, DIEM1*0.1 + DIEM2*0.4 + DIEM3*0.5 AS DIEMHP
FROM SV, MONHOC, DIEM
WHERE DIEM.MASV = SV.MASV AND DIEM.MAMH = MONHOC.MAMH)

--THAY ĐỔI VIEW
ALTER VIEW V_DIEM2 
AS(
SELECT SV.MASV, TENSV, MALOP, DIEM.MAMH, TENMH, GIOITINH, DIEM1, DIEM2, DIEM3, DIEM1*0.1 + DIEM2*0.3 + DIEM3*0.6 AS DIEMHP, ((DIEM1*0.1 + DIEM2*0.3 + DIEM3*0.6) * TONGTC) AS DIEM
FROM SV, MONHOC, DIEM
WHERE DIEM.MASV = SV.MASV AND DIEM.MAMH = MONHOC.MAMH)

--XÓA VIEW 
DROP VIEW V_DIEM2

SELECT COUNT (DISTINCT (MAMH)) AS SOLUONG FROM V_DIEM1
SELECT COUNT (DISTINCT (MASV)) AS SOLUONG FROM V_DIEM1

--MÔN HỌC NÀO CÓ SỐ SV ĐKY NHIỀU NHẤT
SELECT MAMH, COUNT(MAMH) AS SV FROM V_DIEM1
GROUP BY MAMH
HAVING COUNT(MAMH) >= ALL
(SELECT COUNT(MAMH) AS SV FROM V_DIEM1 GROUP BY MAMH)
--MÔN HỌC NÀO CÓ SỐ SV ĐKY ÍT NHẤT
SELECT MAMH, COUNT(MAMH) AS SV FROM V_DIEM1
GROUP BY MAMH
HAVING COUNT(MAMH) <= ALL
(SELECT COUNT(MAMH) AS SV FROM V_DIEM1 GROUP BY MAMH)
--CHO BIẾT LỚP NÀO CÓ SỐ SINH VIÊN NHIỀU NHẤT
SELECT MALOP, COUNT(MASV) AS SOLUONG
FROM SV_LOP
GROUP BY MALOP
HAVING COUNT (MASV) >= ALL
(SELECT COUNT(MASV) AS SL FROM SV_LOP GROUP BY MALOP) 
--CHO BIẾT LỚP NÀO CÓ SỐ SINH VIÊN ÍT NHẤT
SELECT MALOP, COUNT(MASV) AS SOLUONG
FROM SV_LOP
GROUP BY MALOP
HAVING COUNT (MASV) <= ALL
(SELECT COUNT(MASV) AS SL FROM SV_LOP GROUP BY MALOP) 
--HÃY CHO BIẾT LỚP NÀO CHƯA CÓ SINH VIÊN ĐĂNG KÝ
SELECT MALOP, TENLOP FROM LOP WHERE MALOP NOT IN (SELECT MALOP FROM SV)
SELECT MALOP, TENLOP FROM LOP WHERE MALOP IN (SELECT MALOP FROM SV)
--LỚP CÓ SỐ LƯỢNG SINH VIÊN LỚN HƠN 3
SELECT MALOP, TENLOP, COUNT (MASV) AS SL FROM SV_LOP
GROUP BY MALOP, TENLOP
HAVING COUNT (MASV) >= 3

SELECT * FROM SV_LOP WHERE GIOITINH = 'Nam'
SELECT * FROM SV_LOP WHERE MALOP = 'CNTT62A'
SELECT * FROM SV_LOP WHERE MALOP = 'CNTT62B'
SELECT * FROM V_DIEM2

SELECT COUNT(MASV) AS SOLUONG FROM SV_LOP WHERE MONTH(NGAYSINH) = '06'
SELECT COUNT(MASV) AS SOLUONG FROM SV_LOP WHERE MONTH(NGAYSINH) = '05'
SELECT COUNT(MASV) AS SOLUONG FROM SV_LOP WHERE MONTH(NGAYSINH) IN (5,6)

--TẠO 1 VIEW CHO BIẾT THÔNG TIN 4 BẢNG
CREATE VIEW V_DIEM3 
AS(
SELECT SV.MASV, TENSV, GIOITINH, NGAYSINH, TINH, HOCBONG, SV.MALOP, DIEM.MAMH, TENMH, TONGTC, DIEM1, DIEM2, DIEM3, DIEM1*0.1 + DIEM2*0.4 + DIEM3*0.5 AS DIEMHP
FROM SV, MONHOC, DIEM, LOP
WHERE DIEM.MASV = SV.MASV AND DIEM.MAMH = MONHOC.MAMH AND LOP.MALOP = SV.MALOP)

ALTER VIEW V_DIEM3 
AS(
SELECT SV.MASV, TENSV, GIOITINH, NGAYSINH, TINH, HOCBONG, SV.MALOP, DIEM.MAMH, TENMH, TONGTC, DIEM1, DIEM2, DIEM3, DIEM1*0.1 + DIEM2*0.4 + DIEM3*0.5 AS DIEMHP, SOSV
FROM SV, MONHOC, DIEM, LOP
WHERE DIEM.MASV = SV.MASV AND DIEM.MAMH = MONHOC.MAMH AND LOP.MALOP = SV.MALOP)

SELECT * FROM V_DIEM3
--CÁC BẠN NỮ LỚP HTTTQL62A
SELECT * FROM V_DIEM3 WHERE GIOITINH = 'Nữ' AND MALOP = 'HTTQL62A'
--CÁC BẠN NỮ LỚP HTTTQL62A VÀ CNTT62A
SELECT * FROM V_DIEM3 WHERE GIOITINH = 'Nữ' AND MAMH = 'VLDC1' AND MALOP IN ('HTTQL62A' , 'CNTT62A')

